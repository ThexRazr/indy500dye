<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Captain Voting - Beer Dye Tournament</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .voting-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .player-card {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      text-align: center;
      border: 3px solid var(--border);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .player-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .player-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }
    
    .player-card h3 {
      margin: 0;
      font-size: 1.3rem;
    }
    
    .player-card.selected h3 {
      color: white;
    }
    
    .vote-count {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-light);
    }
    
    .player-card.selected .vote-count {
      color: white;
    }
    
    .submit-section {
      position: sticky;
      bottom: 0;
      background: var(--bg);
      padding: 1.5rem;
      border-top: 3px solid var(--border);
      margin-top: 2rem;
    }

    .player-card.disabled {
      opacity: 0.3;
      pointer-events: none;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="header">
      <div class="header-content">
        <h1>üëë Vote for Team Captains</h1>
        <a href="/" class="btn btn-secondary">Home</a>
      </div>
    </div>
    
    <div class="content">
      <div class="container">
        {% if not voting_open %}
        <div class="card text-center">
          <h2>‚è≥ Voting Not Open Yet</h2>
          <p class="text-muted">The admin hasn't opened captain voting yet. Please wait!</p>
          <a href="/registration" class="btn btn-secondary mt-2">Back to Registration</a>
        </div>
        
        {% elif has_voted %}
        <div class="card text-center">
          <h2>‚úÖ Thanks for Voting, {{ voter_name }}!</h2>
          <p class="text-muted mb-3">You've already cast your vote. Waiting for others to finish...</p>
          <a href="/standings" class="btn btn-secondary">View Standings</a>
        </div>
        
        {% else %}
        <!-- Voting Form -->
        <div class="card">
          <h2 class="card-title text-center">Select 2 Captains</h2>
          
          {% if is_admin %}
          <!-- Admin needs to select which player they're voting as -->
          <div class="form-group mb-3">
            <label class="form-label text-center" style="display: block;">Who are you voting as?</label>
            <select id="adminVoterSelect" class="form-input" required onchange="setAdminVoter()">
              <option value="">Select your name</option>
              {% for player in players %}
              {% if player not in voted_players %}
              <option value="{{ player }}">{{ player }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>
          {% endif %}
          
          <p class="text-center text-muted mb-3">
            <strong><span id="currentVoterDisplay">{{ voter_name if not is_admin else 'Select your name above' }}</span></strong>, pick two players for captain{% if not is_admin %} (not yourself!){% endif %}
          </p>
          
          <form method="POST" action="/captain-voting/vote" id="voteForm">
            {% if is_admin %}
            <input type="hidden" name="voter_name" id="adminVoterInput" />
            {% endif %}
            
            <div class="voting-grid" id="votingGrid">
              {% for player in players %}
              <div class="player-card" data-player="{{ player }}" onclick="selectPlayer('{{ player }}')">
                <h3>{{ player }}</h3>
              </div>
              {% endfor %}
            </div>
            
            <input type="hidden" name="captain1" id="captain1" />
            <input type="hidden" name="captain2" id="captain2" />
          </form>
          
          <div class="submit-section">
            <div class="flex-between flex-wrap gap-2">
              <div>
                <p><strong>Selected:</strong> <span id="selectedDisplay">None yet</span></p>
              </div>
              <div class="flex gap-2">
                <button type="button" class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                <button type="submit" form="voteForm" class="btn btn-success" id="submitBtn" disabled>
                  Submit Vote
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Admin-only finalize section -->
        {% if is_admin %}
        <div class="card text-center mt-3">
          <h3>Admin Controls</h3>
          <p class="text-muted mb-2">{{ voted_players|length }} / {{ players|length }} players have voted</p>
          <form method="POST" action="/captain-voting/finalize">
            <button type="submit" class="btn btn-primary btn-large">
              Finalize Captains & Start Draft ‚Üí
            </button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <script>
    let selected = [];
    let currentVoter = '{{ voter_name if not is_admin else "" }}';
    const isAdmin = {{ 'true' if is_admin else 'false' }};
    
    function setAdminVoter() {
      if (!isAdmin) return;
      
      const select = document.getElementById('adminVoterSelect');
      currentVoter = select.value;
      document.getElementById('adminVoterInput').value = currentVoter;
      document.getElementById('currentVoterDisplay').textContent = currentVoter || 'Select your name above';
      
      // Update disabled state for current voter's card
      updateDisabledCards();
      clearSelection();
    }
    
    function updateDisabledCards() {
      document.querySelectorAll('.player-card').forEach(card => {
        const player = card.getAttribute('data-player');
        if (player === currentVoter && !isAdmin) {
          card.classList.add('disabled');
        } else {
          card.classList.remove('disabled');
        }
      });
    }
    
    function selectPlayer(player) {
      if (!currentVoter && isAdmin) {
        alert('Please select who you are voting as first!');
        return;
      }
      
      if (player === currentVoter && !isAdmin) {
        return;
      }
      
      const card = document.querySelector(`[data-player="${player}"]`);
      
      if (selected.includes(player)) {
        selected = selected.filter(p => p !== player);
        card.classList.remove('selected');
      } else if (selected.length < 2) {
        selected.push(player);
        card.classList.add('selected');
      } else {
        const oldPlayer = selected.shift();
        const oldCard = document.querySelector(`[data-player="${oldPlayer}"]`);
        oldCard.classList.remove('selected');
        
        selected.push(player);
        card.classList.add('selected');
      }
      
      updateDisplay();
    }
    
    function updateDisplay() {
      const display = document.getElementById('selectedDisplay');
      const submitBtn = document.getElementById('submitBtn');
      const captain1Input = document.getElementById('captain1');
      const captain2Input = document.getElementById('captain2');
      
      if (selected.length === 0) {
        display.textContent = 'None yet';
        submitBtn.disabled = true;
      } else if (selected.length === 1) {
        display.textContent = selected[0];
        submitBtn.disabled = true;
      } else {
        display.textContent = selected.join(' & ');
        submitBtn.disabled = false;
        captain1Input.value = selected[0];
        captain2Input.value = selected[1];
      }
    }
    
    function clearSelection() {
      document.querySelectorAll('.player-card').forEach(card => {
        card.classList.remove('selected');
      });
      selected = [];
      updateDisplay();
    }
    
    // Initial setup
    updateDisabledCards();
  </script>
</body>
</html>
